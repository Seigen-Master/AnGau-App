// src/lib/firestore.ts
import { db } from '@/lib/firebase';
import { collection, getDocs, getDoc, doc, setDoc, query, where, documentId, addDoc, updateDoc } from 'firebase/firestore';
import type { Schedule, Patient, User } from '@/types';

// --- Schedule Functions --- //

export async function getSchedules(): Promise<Schedule[]> {
  const schedulesCol = collection(db, 'schedules');
  const scheduleSnapshot = await getDocs(schedulesCol);
  const scheduleList = scheduleSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Schedule));
  return scheduleList;
}

// Gets all schedules assigned to a specific caregiver
export const getSchedulesForCaregiver = async (caregiverId: string): Promise<Schedule[]> => {
  const schedulesCol = collection(db, 'schedules');
  const q = query(schedulesCol, where('caregiverId', '==', caregiverId));
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Schedule));
};

// Gets all schedules for a specific caregiver on a specific date
export const getSchedulesForCaregiverOnDate = async (caregiverId: string, date: string): Promise<Schedule[]> => {
  const schedulesCol = collection(db, 'schedules');
  const q = query(
    schedulesCol,
    where('caregiverId', '==', caregiverId),
    where('date', '==', date)
  );
  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Schedule));
};


export async function addSchedule(scheduleData: Omit<Schedule, 'id'>): Promise<string> {
  const schedulesCol = collection(db, 'schedules');
  const docRef = await addDoc(schedulesCol, scheduleData);
  return docRef.id;
}

export async function updateSchedule(scheduleId: string, updatedData: Partial<Schedule>): Promise<void> {
  const scheduleDoc = doc(db, 'schedules', scheduleId);
  await updateDoc(scheduleDoc, updatedData);
}

// --- Patient Functions --- //

export async function getPatients(): Promise<Patient[]> {
  const patientsCol = collection(db, 'patients');
  const patientSnapshot = await getDocs(patientsCol);
  const patientList = patientSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Patient));
  return patientList;
}

// New function to get only specific patients by their IDs
export async function getAssignedPatients(patientIds: string[]): Promise<Patient[]> {
  if (patientIds.length === 0) {
    return [];
  }
  const patientsCol = collection(db, 'patients');
  // Use a 'where' clause with the 'in' operator to fetch only the assigned patients
  const q = query(patientsCol, where(documentId(), 'in', patientIds));
  const patientSnapshot = await getDocs(q);
  const patientList = patientSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Patient));
  return patientList;
}

export async function addPatient(patientData: Omit<Patient, 'id'>): Promise<string> {
  const patientsCol = collection(db, 'patients');
  const docRef = await addDoc(patientsCol, patientData);
  return docRef.id;
}

export async function updatePatient(patientId: string, updatedData: Partial<Patient>): Promise<void> {
  const patientDoc = doc(db, 'patients', patientId);
  await updateDoc(patientDoc, updatedData);
}


// --- User/Caregiver Functions --- //

export async function getUsers(): Promise<User[]> {
  const usersCol = collection(db, 'users');
  const userSnapshot = await getDocs(usersCol);
  const userList = userSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() } as User));
  return userList;
}

export async function getUser(uid: string): Promise<User | null> {
    const userDocRef = doc(db, 'users', uid);
    const userDocSnap = await getDoc(userDocRef);
    if (userDocSnap.exists()) {
        return { uid: userDocSnap.id, ...userDocSnap.data() } as User;
    }
    return null;
}

export async function updateUser(uid: string, updatedData: Partial<User>): Promise<void> {
  const userDoc = doc(db, 'users', uid);
  await updateDoc(userDoc, updatedData);
}

// Gets a single schedule by its ID
export const getScheduleById = async (scheduleId: string): Promise<Schedule | null> => {
  const scheduleDocRef = doc(db, 'schedules', scheduleId);
  const scheduleDocSnap = await getDoc(scheduleDocRef);
  if (scheduleDocSnap.exists()) {
    return { id: scheduleDocSnap.id, ...scheduleDocSnap.data() } as Schedule;
  }
  return null;
};

